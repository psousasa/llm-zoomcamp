from typing import Dict, List, Union

import numpy as np
from elasticsearch import Elasticsearch

if 'data_loader' not in globals():
    from mage_ai.data_preparation.decorators import data_loader
if 'test' not in globals():
    from mage_ai.data_preparation.decorators import test


@data_loader
def search(*args, **kwargs) -> List[Dict]:
    connection_string = kwargs.get('connection_strin', 'http://elasticsearch:9200')
    index_name = kwargs.get('index_nam', 'documents_20240819_1629')
    source = kwargs.get('source', "cosineSimilarity(params.query_vector, 'embedding') + 1.0")
    top_k = kwargs.get('top_k', 5)
    chunk_column = kwargs.get('chunk_column', 'content')
    print(index_name)
    query_embedding = [-0.01992741, -0.02673646,  0.04029195, -0.01362509,  0.0047257 ,
       -0.00706697, -0.03119536,  0.04533839, -0.030974  , -0.010597  ,
        0.0038244 , -0.07381699,  0.03348412,  0.01226871, -0.00687989,
        0.01744031,  0.02941949, -0.04669411, -0.04643574, -0.04930811,
        0.00846998, -0.03702852,  0.00558356,  0.02357239,  0.00561718,
        0.00369334,  0.07708501,  0.00555711,  0.05316998, -0.00253381,
       -0.05124455, -0.0332763 ,  0.07615184,  0.07889067,  0.04927429,
       -0.01607682, -0.01609846,  0.0217542 ,  0.04100404, -0.00264142,
        0.02674238, -0.09935284, -0.04116396, -0.05951858, -0.03461329,
        0.04881553,  0.01251886,  0.01481665, -0.00598287, -0.0243463 ,
       -0.01007094, -0.03871192, -0.01033881, -0.02165511,  0.01098548,
       -0.04104466,  0.02480651, -0.04961138, -0.01729394, -0.00829382,
        0.00211542, -0.00873371, -0.03836415, -0.00351219, -0.0390868 ,
       -0.05222329,  0.00979145, -0.00525437,  0.01049354, -0.01557248,
       -0.03203204,  0.04134677,  0.04607077,  0.01555167, -0.00209861,
       -0.03870469, -0.05854643,  0.06357457,  0.00130895, -0.05357312,
        0.00744564, -0.02905038,  0.00713452, -0.00021365,  0.0080951 ,
        0.06836731, -0.01489483,  0.02854578, -0.06140815,  0.05175878,
       -0.06678112, -0.02637535,  0.01122099,  0.04677932,  0.04415929,
        0.00130247,  0.03406838, -0.01951603,  0.05372341, -0.05375869,
        0.01344198, -0.02536903,  0.00132856,  0.00869211, -0.05279488,
        0.03185711,  0.03287422, -0.06332203, -0.01407515, -0.02457078,
        0.04237562,  0.01640273,  0.02655245,  0.04436474, -0.00101167,
        0.02859279,  0.02737951,  0.0128118 , -0.09253278, -0.01532604,
       -0.08324829,  0.02737604, -0.01341662,  0.05068593, -0.03431312,
        0.06086929,  0.00338634,  0.00160816,  0.00792326, -0.07961106,
       -0.00960081, -0.0510948 , -0.04603793,  0.00797933,  0.02654873,
        0.02621062, -0.01730188,  0.04203692,  0.01262138,  0.07868416,
        0.01852588, -0.03458631,  0.05628823,  0.02723928,  0.01216446,
       -0.04417042, -0.05270582, -0.00545415, -0.0342049 ,  0.02804992,
        0.02645974, -0.02144203, -0.02107587, -0.02963566,  0.0378771 ,
       -0.05623019,  0.01240477,  0.00425167,  0.02382403, -0.01051509,
       -0.00933   ,  0.04837084, -0.01009656, -0.01407195, -0.03008606,
        0.04411906, -0.00732338, -0.0325761 , -0.00873224, -0.01218111,
        0.02097308, -0.06611862, -0.03641314,  0.00913914,  0.04886293,
       -0.03548088, -0.00692703, -0.0201568 , -0.02331581,  0.0060126 ,
       -0.07840694,  0.00777166,  0.01653729,  0.01559363,  0.07032204,
       -0.05036999, -0.07880095, -0.0182712 , -0.00332517,  0.03607788,
        0.00764983,  0.00853385, -0.00994409,  0.01063834,  0.01562202,
       -0.06056285,  0.04030427, -0.01669702, -0.05360127, -0.01521858,
       -0.03701389,  0.05594105,  0.04792968,  0.06323683, -0.02450635,
       -0.03390703,  0.0012154 , -0.03225439, -0.0320214 ,  0.0097628 ,
       -0.0583472 ,  0.0433838 , -0.05751028,  0.00515598,  0.02264678,
        0.00738455, -0.01101762, -0.02876648, -0.03483151, -0.0210504 ,
        0.01329081, -0.0439355 , -0.01699527,  0.00413837, -0.02744154,
       -0.02624169, -0.00529363,  0.0354443 , -0.00299022, -0.05067853,
        0.08612303, -0.04376492, -0.01416936,  0.05149832,  0.02446145,
        0.01622367, -0.0518773 , -0.03334716, -0.02915966, -0.00828415,
        0.00327649,  0.0090445 ,  0.07380389,  0.0374223 ,  0.01958347,
       -0.01220388,  0.04376055,  0.07398043, -0.01600561,  0.02247909,
       -0.00583661, -0.05502815, -0.02281456, -0.00855041,  0.00197959,
       -0.01705532,  0.04424686,  0.03665764,  0.05991663,  0.00221569,
        0.06942945, -0.02103179,  0.03689116,  0.02830072, -0.00258383,
        0.00401222,  0.02008052, -0.02719315,  0.00125055, -0.02680913,
       -0.01657035,  0.02657429,  0.08080013,  0.00026634, -0.01387158,
       -0.0526919 ,  0.01856644,  0.01500191,  0.05276367, -0.00518327,
       -0.0238119 , -0.0101084 , -0.01887186,  0.02128629,  0.02501516,
       -0.05344443, -0.00986623,  0.05349559,  0.04173864,  0.01229076,
        0.02279396,  0.02767967,  0.00984362,  0.0152145 ,  0.04205825,
       -0.03287804,  0.01850566, -0.03265278, -0.03957051,  0.06162853,
       -0.03577853, -0.06243657,  0.05469612, -0.01231586, -0.00297281,
       -0.03675189,  0.07165129, -0.03295046, -0.03645276, -0.02594658,
       -0.03418948,  0.02724924,  0.05591547, -0.00432743,  0.00597311,
       -0.0239249 ,  0.00403513,  0.03342495,  0.03192141, -0.00406897,
       -0.00076856,  0.05324363, -0.03937137,  0.01364575,  0.00500076,
        0.02477957,  0.02520016, -0.0069336 ,  0.07270956,  0.01118036,
       -0.02254647,  0.00965615, -0.04714381, -0.04296114, -0.07205927,
        0.00018703,  0.00339433, -0.03197749, -0.02961905,  0.00539313,
        0.05502292,  0.03974908,  0.01499798, -0.01519994, -0.02085054,
        0.07784575, -0.02900924, -0.07896279,  0.00663414, -0.03909377,
       -0.06900679,  0.01383601,  0.04145494,  0.0672425 ,  0.00614509,
       -0.01301884, -0.00225259,  0.01048116,  0.00169758,  0.06206813,
        0.03838334,  0.03335525, -0.0252365 , -0.00960776, -0.05141982,
        0.05140969, -0.00140262, -0.03361811, -0.01614662,  0.0141609 ,
        0.03962533, -0.04749199, -0.01965441, -0.01981468, -0.01912687,
        0.06698132, -0.00096544, -0.01860603, -0.00410377,  0.02568411,
       -0.06040054, -0.01371989, -0.06856909, -0.05568356,  0.07961369,
       -0.00745112,  0.03703087,  0.04534786,  0.06624839, -0.00893317,
        0.06176978,  0.0282138 ,  0.04494458, -0.00549444,  0.03771565,
        0.02057768, -0.01683218,  0.04188039, -0.0940584 ,  0.01223556,
        0.03848851,  0.04663245,  0.03534213,  0.00327292, -0.02374041,
        0.07714615, -0.01754625,  0.04557266,  0.03401973,  0.02499686,
       -0.04317869,  0.03777849, -0.0588778 , -0.03357779, -0.0478042 ,
        0.0702262 ,  0.05696842,  0.04620883,  0.07335781, -0.01117477,
        0.08286592, -0.11091404, -0.00350128,  0.00842862, -0.02774005,
        0.03299501,  0.00106677,  0.06436501, -0.00702573, -0.02190536,
       -0.07008175,  0.05204697, -0.00963115, -0.03561272, -0.01583458,
        0.01007946,  0.02351843,  0.01207896,  0.0107463 ,  0.04050279,
       -0.044112  , -0.01485979,  0.00177087, -0.02111241, -0.04018012,
        0.01911453,  0.03646993,  0.00569846, -0.01935826,  0.01754692,
       -0.02926407,  0.02058255, -0.01910525,  0.01384921,  0.00332888,
        0.05621528, -0.05981729,  0.01021381,  0.0616909 ,  0.07704341,
        0.00539489,  0.03268459,  0.02970858, -0.02017682, -0.00869103,
        0.00961901,  0.001084  , -0.00974158, -0.02489663,  0.02484299,
       -0.03239432, -0.07683609,  0.01976505,  0.04214301, -0.00559573,
       -0.00985948, -0.00212913, -0.03399492, -0.00164027, -0.02015339,
       -0.0307672 , -0.02098991,  0.02582085, -0.00777821,  0.04492749,
        0.0209258 ,  0.00086703, -0.02142197, -0.00063395,  0.06612226,
       -0.01121988, -0.03805181,  0.02691611,  0.04134861,  0.03430657,
       -0.05295134,  0.04119673,  0.01602409,  0.02044158,  0.01829489,
       -0.02258225, -0.04301203, -0.06184858, -0.01125224, -0.01170533,
       -0.00568099,  0.01478016,  0.04628241, -0.02644068,  0.06547362,
        0.04507952,  0.02712082,  0.03387391,  0.00794228, -0.00332571,
       -0.01855145, -0.04049822, -0.01325113,  0.02417388,  0.0443538 ,
        0.06133734,  0.00579874,  0.06596815, -0.05756583, -0.06728835,
       -0.00280462, -0.01209299,  0.05263188, -0.04477343,  0.05178193,
       -0.02772348, -0.05604763,  0.04000902, -0.01015384, -0.04125987,
       -0.04461652, -0.03783322, -0.00993965,  0.02179245,  0.01948128,
       -0.02256703, -0.03064625, -0.11545702,  0.02019396,  0.02219931,
       -0.01881117, -0.00989782,  0.01042746, -0.04148218, -0.04700745,
        0.01503383, -0.08314423, -0.02472549,  0.00189928, -0.0097767 ,
        0.00848716,  0.06195137,  0.01391277,  0.01047207,  0.00444451,
        0.01932995, -0.0262841 , -0.04227046,  0.01986678, -0.03241623,
       -0.02647283,  0.00110316, -0.01625362,  0.01999849, -0.01493682,
       -0.02256718,  0.000905  ,  0.01229965,  0.00633658, -0.02354664,
       -0.05935548,  0.00128164,  0.0741149 , -0.02010289, -0.0097317 ,
       -0.03078589, -0.02402624,  0.04315997,  0.00164031, -0.02401772,
        0.03627877,  0.0047866 ,  0.01048278, -0.00032051,  0.06320467,
       -0.05046642,  0.11116792,  0.04557185, -0.03761547, -0.02971685,
        0.03214313, -0.0060893 ,  0.01651629,  0.05396693,  0.00932029,
       -0.0527421 ,  0.05020021,  0.07663665,  0.04963853,  0.05849371,
       -0.01177985, -0.04475225,  0.03876259, -0.00568279,  0.04325473,
        0.01772049,  0.00059738, -0.06898137, -0.00082588, -0.00127575,
        0.04906444, -0.03153925,  0.05854573,  0.03365334,  0.01261803,
        0.02766257,  0.06180284, -0.04241668,  0.05897142, -0.02481825,
       -0.02690685, -0.00851286, -0.0405735 , -0.03084566,  0.02118558,
       -0.01282706,  0.0358847 , -0.0288359 ,  0.00061971,  0.02460511,
       -0.02862234, -0.00392669,  0.00282808, -0.04181051,  0.05459271,
       -0.0011784 , -0.00023259, -0.04385748, -0.03108038, -0.00939331,
       -0.02577481,  0.00465523,  0.08188299,  0.00491035,  0.03753347,
       -0.00680117, -0.02665023,  0.0188559 ,  0.00106321, -0.04820698,
       -0.00246363,  0.06683787,  0.01155675,  0.00444896, -0.06079232,
       -0.00377735, -0.00480197,  0.02324548,  0.05160667, -0.00352634,
        0.06254914,  0.03274632,  0.02018523, -0.00487305, -0.01833289,
       -0.02147838, -0.04902641,  0.00960171, -0.02721674, -0.03287439,
        0.00660779,  0.01408374,  0.00989891,  0.01301509,  0.00999064,
       -0.03293095, -0.00128617,  0.03399961,  0.02690269, -0.05256935,
       -0.00511935,  0.03451663, -0.01134824, -0.03849665, -0.0207437 ,
       -0.01471701,  0.07522801, -0.06306922,  0.00321203,  0.0224946 ,
        0.02701441, -0.00730441,  0.02565297, -0.01788164, -0.03167347,
        0.01998957,  0.01779273, -0.03040852,  0.00377787,  0.06578571,
       -0.01609907,  0.00755665, -0.00321022, -0.02820081, -0.03798514,
       -0.01811423, -0.03177005,  0.03090681, -0.06337031,  0.03012056,
        0.03449737, -0.01069844, -0.0090898 ,  0.00271464, -0.00957023,
       -0.02688106,  0.0732995 ,  0.03284908,  0.04423438, -0.03719511,
       -0.04864369, -0.00319034, -0.02089274, -0.03248154, -0.01948453,
       -0.00306899,  0.0003561 , -0.00227333,  0.05239659, -0.01000406,
        0.02160362,  0.00203213,  0.03738229,  0.03386487,  0.00469199,
       -0.00550982, -0.03254434,  0.04207723, -0.05724434, -0.00331495,
       -0.01426927,  0.04355506,  0.04416164, -0.00113233, -0.02895177,
        0.03284937,  0.01686756, -0.00026561,  0.01923473,  0.0163353 ,
       -0.00099275,  0.00053631, -0.02828464, -0.04765132,  0.01598656,
       -0.01558178,  0.0224044 , -0.04853579, -0.05290702, -0.04166443,
       -0.02218407,  0.01181081, -0.02299891]

    script_query = {
        "script_score": {
            "query": {"match_all": {}},
            "script": {
                "source": source,
                "params": {"query_vector": query_embedding}
            }
        }
    }

    es_client = Elasticsearch(connection_string)

    response = es_client.search(
        index=index_name,
        body=dict(
            size=top_k,
            query=script_query,
            _source=[chunk_column],
        ),
    )
\
    return [hit['_source']['content'] for hit in response['hits']['hits']]


@test
def test_output(output, *args) -> None:
    """
    Template code for testing the output of the block.
    """
    assert output is not None, 'The output is undefined'